<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>매물 상세 정보</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f6f6f6;
    }
    .header {
      display: flex;
      align-items: center;
      padding: 16px 40px;
      background-color: white;
      border-bottom: 1px solid #ddd;
    }
    .header img {
      width: 50px;
      margin-right: 10px;
    }
    .header h1 {
      font-size: 20px;
      margin: 0;
    }
    .container {
      display: flex;
      height: calc(100vh - 80px);
    }
    .sidebar {
      width: 25%;
      background-color: #f9f9f9;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
    }
    .category-buttons {
      display: flex;
      gap: 10px;
    }
    .category-buttons button {
      flex: 1;
      padding: 10px;
      font-weight: bold;
      background-color: #fde4de;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .card {
      background-color: white;
      border-radius: 5px;
      padding: 16px;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
      cursor: pointer;
    }
    .details {
      width: 60%;
      padding: 30px;
      background-color: white;
      border-left: 1px solid #ccc;
    }
    .details h2 {
      font-size: 18px;
      margin-bottom: 5px;
    }
    .details .price {
      font-weight: bold;
      margin-bottom: 20px;
    }
    .image-box {
      position: relative;
      width: 800px;
      height: 500px;
      background-color: #f2f2f2;
      margin-top: 0px;
      margin-bottom: 20px;
      border-radius: 5px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .house-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .slider-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
      font-size: 20px;
      border-radius: 50%;
    }
    .slider-btn.left { left: 10px; }
    .slider-btn.right { right: 10px; }
    .map {
      width: 200%;
      height: 400px;
    }
    .button-row {
      margin-top: 20px;
    }
    .button-row button {
      padding: 10px 20px;
      background-color: #dcdcdc;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      margin-right: 10px;
    }
    .button-row button:hover {
      background-color: #bbb;
    }
    .btn-top {
      float: right;
      background-color: #f0f0f0;
      font-size: 12px;
      padding: 5px 12px;
    }
  </style>
</head>
<body>
  <!-- 헤더 -->
  <div class="header">
    <a href="index.html">
      <img src="bangu.png" alt="마스코트 캐릭터" />
    </a>
    
  </div>

  <!-- 본문 -->
  <div class="container">
    <!-- 사이드바 -->
    <div class="sidebar" id="room-list">
      <div class="category-buttons">
        <button>중앙</button>
        <button>가격</button>
        <button>치안</button>
        <button>거리</button>
      </div>
    </div>

    <!-- 상세 정보 -->
    <div class="details">
      <h2 id="room-title">매물 상세</h2>
      <div class="price" id="room-price"></div>
      <div class="info"><strong>주소:</strong> <span id="room-address"></span></div>
      <button onclick="location.href='agent_detail.html'" class="btn gray">공인중개사 정보 더보기</button>

      <!-- 이미지 박스 (슬라이드) -->
      <div class="image-box" id="image-gallery"></div>
        <button class="slider-btn left" onclick="prevImage()">&#x25C0;</button>
        <img id="room-image" class="house-img" src="" alt="매물 사진">
        <button class="slider-btn right" onclick="nextImage()">&#x25B6;</button>
      

      <!-- 지도 -->
      <div class="map" id="map"></div>
    </div>
  </div>

  <!-- Kakao 지도 SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=306c594bc70125ed78c30c9e79de0019&autoload=false&libraries=services"></script>
  <script>
    let map;
    let images = [];
    let currentIndex = 0;

    async function loadRoom() {
      const params = new URLSearchParams(window.location.search);
      const roomId = params.get("id");

      // FastAPI에서 매물 상세정보 요청
      const res = await fetch(`http://127.0.0.1:8000/room/${roomId}`);
      const data = await res.json();
      const room = data.room;
      images = data.images.map(i => i.image_path);  // 여러 장 이미지 배열

      // 상세 정보 반영
      document.getElementById("room-title").textContent = `매물 ${room.id}`;
      document.getElementById("room-price").textContent =
        `${room.transaction_type} / 보증금 ${room.deposit} / 월세 ${room.rent} / 관리비 ${room.management_fee}`;
      document.getElementById("room-address").textContent = room.property_address;

      // 첫 이미지 세팅
      if (images.length > 0) {
        document.getElementById("room-image").src = images[0];
      }

      // 지도 로드
      kakao.maps.load(function() {
        const mapContainer = document.getElementById('map');
        const mapOption = {
          center: new kakao.maps.LatLng(room.latitude, room.longitude),
          level: 3
        };
        map = new kakao.maps.Map(mapContainer, mapOption);

        const markerPosition = new kakao.maps.LatLng(room.latitude, room.longitude);
        const marker = new kakao.maps.Marker({ position: markerPosition });
        marker.setMap(map);
      });
    }
     
    function nextImage() {
      if (images.length === 0) return;
      currentIndex = (currentIndex + 1) % images.length;
      document.getElementById("room-image").src = images[currentIndex];
    }

    function prevImage() {
      if (images.length === 0) return;
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      document.getElementById("room-image").src = images[currentIndex];
    }

    loadRoom();
  </script>

  <script>
    async function loadSidebarRooms() {
      const response = await fetch("http://127.0.0.1:8000/rooms");
      const rooms = await response.json();
      const list = document.getElementById("room-list");

      rooms.forEach((room, idx) => {
        const card = document.createElement("div");
        card.className = "card";
        card.onclick = () => location.href = `property_detail.html?id=${room.id}`;
        card.innerHTML = `
          <h3>매물 ${idx+1}: ${room.property_address}</h3>
          <p>매물정보: ${room.transaction_type} / 보증금 ${room.deposit || 0} / 월세 ${room.rent || 0} / 관리비 ${room.management_fee || 0}</p>
        `;
        list.appendChild(card);
      });
    }

    loadSidebarRooms();
  </script>
</body>
</html>
